<!DOCTYPE etl SYSTEM "http://scriptella.org/dtd/etl.dtd">
<etl>
  <description>Imports taxon data</description>

  <connection
    id="db1"
    url="${db.url}"
    driver="postgresql"
    user="${db.user}"
    password="${db.password}"
  >
    statement.fetchSize=100
  </connection>

  <connection
    id="db2"
    url="${db.url}"
    driver="postgresql"
    user="${db.user}"
    password="${db.password}"
  >
    statement.batchSize=100
  </connection>

  <query connection-id="db1">
    SELECT
      src_taxon_name_id,
      taxon_rank,
      tsn.scientific_name
    FROM
      sapin.tmp_taxon_scientific_name
      JOIN sapin.taxon_scientific_name tsn USING (src_taxon_name_id)
    WHERE
      tsn.taxonomic_status != 'SYNONYM'
    <script connection-id="db2">
      INSERT INTO sapin.taxon (
        src_taxon_name_id,
        taxon_rank,
        accepted_name
      )
      VALUES (
        ?src_taxon_name_id,
        upper(?taxon_rank)::sapin.taxon_rank_enum,
        ?scientific_name
      )
    </script>
  </query>
</etl>
